name: CI/CD - Test Application

'on':
  pull_request:
    branches:
      - main
      - feature/**
  push:
    branches:
      - main
      - feature/initial-implementation

jobs:
  # Backend API Tests
  backend-tests:
    name: Backend API Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_USER: bible
          POSTGRES_PASSWORD: bible123  # pragma: allowlist secret
          POSTGRES_DB: bibledb
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: 'api/requirements.txt'

      - name: Install dependencies
        run: |
          cd api
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install ruff black mypy

      - name: Lint with Ruff
        run: |
          cd api
          ruff check . --select E,F,W,C90,I,N --ignore E501

      - name: Format check with Black
        run: |
          cd api
          black --check --diff .

      - name: Type check with MyPy
        run: |
          cd api
          mypy . --ignore-missing-imports --no-strict-optional

      - name: Run pytest
        env:
          DATABASE_URL: postgresql://bible:bible123@localhost:5432/bibledb  # pragma: allowlist secret
          LLM_PROVIDER: ollama
          OLLAMA_HOST: http://localhost:11434
        run: |
          cd api
          pytest -v --tb=short

      - name: Test API syntax and imports
        run: |
          cd api
          python -c "import main; import config; print('✓ Core modules import successfully')"
          python -c "from routes import chat, scripture; print('✓ Route modules import successfully')"
          python -c "from providers import factory; print('✓ Provider modules import successfully')"
          python -c "from scripture import repository, search; print('✓ Scripture modules import successfully')"

  # Frontend Tests
  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Lint
        run: |
          cd frontend
          npm run lint

      - name: Type check
        run: |
          cd frontend
          npx tsc --noEmit

      - name: Build
        run: |
          cd frontend
          npm run build

  # Integration Tests
  # Only run after unit tests pass to save CI resources
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file
        run: | # pragma: allowlist secret
          cat > api/.env << EOF
          LLM_PROVIDER=ollama
          LLM_MODEL=llama3:8b
          OLLAMA_HOST=http://ollama:11434
          DATABASE_URL=postgresql://bible:bible123@postgres:5432/bibledb  # pragma: allowlist secret
          EMBEDDING_MODEL=nomic-embed-text
          EOF

      - name: Build Docker images
        run: |
          docker compose build api frontend

      - name: Start services
        run: |
          docker compose up -d postgres
          sleep 10

      - name: Check PostgreSQL health
        run: |
          docker compose exec -T postgres pg_isready -U bible -d bibledb

      - name: Start API service
        run: |
          docker compose up -d api
          sleep 15

      - name: Test API health endpoint
        run: |
          max_attempts=30
          attempt=0
          until curl -f http://localhost:8000/health || [ $attempt -eq $max_attempts ]; do
            attempt=$((attempt + 1))
            echo "Waiting for API... attempt $attempt/$max_attempts"
            sleep 2
          done
          if [ $attempt -eq $max_attempts ]; then
            echo "API failed to start"
            docker compose logs api
            exit 1
          fi

      - name: Test API endpoints
        run: |
          # Test health endpoint
          curl -f http://localhost:8000/health | jq .

          # Test config endpoint
          curl -f http://localhost:8000/config | jq .

      - name: Start Frontend service
        run: |
          docker compose up -d frontend
          sleep 20

      - name: Test Frontend health
        run: |
          max_attempts=30
          attempt=0
          until curl -f http://localhost:3000 || [ $attempt -eq $max_attempts ]; do
            attempt=$((attempt + 1))
            echo "Waiting for Frontend... attempt $attempt/$max_attempts"
            sleep 2
          done
          if [ $attempt -eq $max_attempts ]; then
            echo "Frontend failed to start"
            docker compose logs frontend
            exit 1
          fi

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== API Logs ==="
          docker compose logs api
          echo "=== Frontend Logs ==="
          docker compose logs frontend
          echo "=== PostgreSQL Logs ==="
          docker compose logs postgres

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v

  # Security & Dependencies Check
  security-check:
    name: Security & Dependency Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Check Python dependencies for vulnerabilities
        run: |
          cd api
          pip install safety
          safety check -r requirements.txt --ignore 70612
        continue-on-error: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Check npm dependencies for vulnerabilities
        run: |
          cd frontend
          npm audit --audit-level=high
        continue-on-error: true
